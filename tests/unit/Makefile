# tests/unit/Makefile
# Makefile for NetworkSecurityAI Unit Tests

# ==================== Compiler Settings ====================
CXX := g++
CXXFLAGS := -std=c++17 -Wall -Wextra -O2 -g
INCLUDES := -I../../src/common
LDFLAGS := -L../../lib
LIBS := -lcommon -lgtest -lgtest_main -lpthread -lcrypto -lz

# ==================== Directories ====================
SRC_DIR := ../../src/common
BUILD_DIR := build
BIN_DIR := bin
LIB_DIR := ../../lib

# ==================== Test Files ====================
TEST_SOURCES := \
	test_common_utils.cpp \
	test_common_logger.cpp \
	test_common_config_manager.cpp \
	test_common_network_utils.cpp \
	test_common_packet_parser.cpp \
	test_common_flow_manager.cpp

# ==================== Test Executables ====================
TEST_EXECUTABLES := $(TEST_SOURCES:%.cpp=$(BIN_DIR)/%)

# ==================== Targets ====================

.PHONY: all clean run test help dirs

# Default target
all: dirs $(TEST_EXECUTABLES)

# Create necessary directories
dirs:
	@mkdir -p $(BUILD_DIR)
	@mkdir -p $(BIN_DIR)
	@mkdir -p test_logs

# ==================== Build Individual Tests ====================

$(BIN_DIR)/test_common_utils: test_common_utils.cpp
	@echo "ðŸ”¨ Compiling $@..."
	@$(CXX) $(CXXFLAGS) $(INCLUDES) $< -o $@ $(LDFLAGS) $(LIBS)
	@echo "âœ… $@ compiled successfully!"

$(BIN_DIR)/test_common_logger: test_common_logger.cpp
	@echo "ðŸ”¨ Compiling $@..."
	@$(CXX) $(CXXFLAGS) $(INCLUDES) $< -o $@ $(LDFLAGS) $(LIBS)
	@echo "âœ… $@ compiled successfully!"

$(BIN_DIR)/test_common_config_manager: test_common_config_manager.cpp
	@echo "ðŸ”¨ Compiling $@..."
	@$(CXX) $(CXXFLAGS) $(INCLUDES) $< -o $@ $(LDFLAGS) $(LIBS)
	@echo "âœ… $@ compiled successfully!"

$(BIN_DIR)/test_common_network_utils: test_common_network_utils.cpp
	@echo "ðŸ”¨ Compiling $@..."
	@$(CXX) $(CXXFLAGS) $(INCLUDES) $< -o $@ $(LDFLAGS) $(LIBS)
	@echo "âœ… $@ compiled successfully!"

$(BIN_DIR)/test_common_packet_parser: test_common_packet_parser.cpp
	@echo "ðŸ”¨ Compiling $@..."
	@$(CXX) $(CXXFLAGS) $(INCLUDES) $< -o $@ $(LDFLAGS) $(LIBS)
	@echo "âœ… $@ compiled successfully!"

$(BIN_DIR)/test_common_flow_manager: test_common_flow_manager.cpp
	@echo "ðŸ”¨ Compiling $@..."
	@$(CXX) $(CXXFLAGS) $(INCLUDES) $< -o $@ $(LDFLAGS) $(LIBS)
	@echo "âœ… $@ compiled successfully!"

# ==================== Run All Tests ====================

run: all
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘         ðŸš€ Running All Unit Tests                          â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@for test in $(TEST_EXECUTABLES); do \
		echo ""; \
		echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"; \
		echo "â–¶ï¸  Running: $$test"; \
		echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"; \
		./$$test || exit 1; \
		echo ""; \
	done
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘         âœ… All Tests Passed Successfully!                  â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# Alias for run
test: run

# ==================== Run Individual Tests ====================

test-utils: $(BIN_DIR)/test_common_utils
	@echo "ðŸ§ª Running Utils Tests..."
	@./$(BIN_DIR)/test_common_utils

test-logger: $(BIN_DIR)/test_common_logger
	@echo "ðŸ§ª Running Logger Tests..."
	@./$(BIN_DIR)/test_common_logger

test-config: $(BIN_DIR)/test_common_config_manager
	@echo "ðŸ§ª Running Config Manager Tests..."
	@./$(BIN_DIR)/test_common_config_manager

test-network: $(BIN_DIR)/test_common_network_utils
	@echo "ðŸ§ª Running Network Utils Tests..."
	@./$(BIN_DIR)/test_common_network_utils

test-parser: $(BIN_DIR)/test_common_packet_parser
	@echo "ðŸ§ª Running Packet Parser Tests..."
	@./$(BIN_DIR)/test_common_packet_parser

test-flow: $(BIN_DIR)/test_common_flow_manager
	@echo "ðŸ§ª Running Flow Manager Tests..."
	@./$(BIN_DIR)/test_common_flow_manager

# ==================== Run Tests with Verbose Output ====================

run-verbose: all
	@echo "ðŸš€ Running All Tests (Verbose Mode)..."
	@for test in $(TEST_EXECUTABLES); do \
		echo ""; \
		echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"; \
		echo "â–¶ï¸  Running: $$test"; \
		echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"; \
		./$$test --gtest_print_time=1 --gtest_color=yes || exit 1; \
		echo ""; \
	done

# ==================== Run Tests with Filter ====================

run-filter:
	@if [ -z "$(FILTER)" ]; then \
		echo "âŒ Error: Please specify FILTER"; \
		echo "Usage: make run-filter FILTER='TestSuiteName.TestName'"; \
		exit 1; \
	fi
	@echo "ðŸ” Running tests matching filter: $(FILTER)"
	@for test in $(TEST_EXECUTABLES); do \
		./$$test --gtest_filter=$(FILTER) || exit 1; \
	done

# ==================== Generate Test Report ====================

report: all
	@echo "ðŸ“Š Generating Test Report..."
	@mkdir -p reports
	@for test in $(TEST_EXECUTABLES); do \
		test_name=$$(basename $$test); \
		echo "Running $$test_name..."; \
		./$$test --gtest_output=xml:reports/$$test_name.xml; \
	done
	@echo "âœ… Test reports generated in reports/ directory"

# ==================== Memory Check with Valgrind ====================

valgrind: all
	@echo "ðŸ” Running Tests with Valgrind..."
	@for test in $(TEST_EXECUTABLES); do \
		echo ""; \
		echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"; \
		echo "ðŸ” Valgrind: $$test"; \
		echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"; \
		valgrind --leak-check=full --show-leak-kinds=all \
			--track-origins=yes --verbose \
			./$$test || exit 1; \
		echo ""; \
	done

# ==================== Code Coverage ====================

coverage: CXXFLAGS += -fprofile-arcs -ftest-coverage
coverage: LIBS += -lgcov
coverage: clean all
	@echo "ðŸ“Š Running Tests with Coverage..."
	@for test in $(TEST_EXECUTABLES); do \
		./$$test; \
	done
	@echo "ðŸ“Š Generating Coverage Report..."
	@lcov --capture --directory . --output-file coverage.info
	@genhtml coverage.info --output-directory coverage_report
	@echo "âœ… Coverage report generated in coverage_report/"

# ==================== Clean ====================

clean:
	@echo "ðŸ§¹ Cleaning up..."
	@rm -rf $(BUILD_DIR)
	@rm -rf $(BIN_DIR)
	@rm -rf test_logs
	@rm -rf reports
	@rm -rf coverage_report
	@rm -f *.gcda *.gcno *.gcov coverage.info
	@echo "âœ… Cleanup complete!"

# ==================== Help ====================

help:
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘         NetworkSecurityAI Unit Tests - Makefile            â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "Available targets:"
	@echo ""
	@echo "  ðŸ“¦ Build Targets:"
	@echo "    all              - Build all test executables (default)"
	@echo "    dirs             - Create necessary directories"
	@echo ""
	@echo "  ðŸ§ª Test Targets:"
	@echo "    run / test       - Build and run all tests"
	@echo "    run-verbose      - Run all tests with verbose output"
	@echo "    run-filter       - Run tests matching filter (use FILTER=...)"
	@echo ""
	@echo "  ðŸŽ¯ Individual Tests:"
	@echo "    test-utils       - Run Utils tests only"
	@echo "    test-logger      - Run Logger tests only"
	@echo "    test-config      - Run Config Manager tests only"
	@echo "    test-network     - Run Network Utils tests only"
	@echo "    test-parser      - Run Packet Parser tests only"
	@echo "    test-flow        - Run Flow Manager tests only"
	@echo ""
	@echo "  ðŸ“Š Analysis Targets:"
	@echo "    report           - Generate XML test reports"
	@echo "    valgrind         - Run tests with Valgrind memory check"
	@echo "    coverage         - Generate code coverage report"
	@echo ""
	@echo "  ðŸ§¹ Utility Targets:"
	@echo "    clean            - Remove all build artifacts"
	@echo "    help             - Show this help message"
	@echo ""
	@echo "Examples:"
	@echo "  make                              # Build all tests"
	@echo "  make run                          # Build and run all tests"
	@echo "  make test-logger                  # Run logger tests only"
	@echo "  make run-filter FILTER='Utils*'   # Run tests matching 'Utils*'"
	@echo "  make valgrind                     # Run with memory check"
	@echo "  make coverage                     # Generate coverage report"
	@echo ""
